# Use Ubuntu 20.04 base image for compatibility with newer PHP versions
FROM vm/ubuntu:20.04

# Note: Layerfiles create entire VMs, not containers.

# Install PHP 8.1 and Composer
RUN apt-get update && \
    apt-get install -y software-properties-common && \
    add-apt-repository ppa:ondrej/php -y && \
    apt-get update && \
    apt-get install -y curl php8.1-cli php8.1-mbstring php8.1-zip php8.1-xml \
                       php8.1-curl php8.1-mysql git unzip

# Install Composer globally
RUN curl -sS https://getcomposer.org/installer -o composer-setup.php && \
    php composer-setup.php --install-dir=/usr/local/bin --filename=composer && \
    rm composer-setup.php

# Copy project files and install Laravel dependencies
COPY . /app
WORKDIR /app
RUN composer install --no-interaction --prefer-dist --optimize-autoloader

# Set up the environment and generate application key
RUN cp .env.example .env
RUN php artisan key:generate

# Configure SQLite database (or configure for MySQL as needed)
RUN touch database/database.sqlite
RUN php artisan migrate --force

# Start the Laravel server in the background
RUN php artisan serve --host=0.0.0.0 --port=8000 &

# Expose a preview link for webapp.io
EXPOSE WEBSITE http://localhost:8000
